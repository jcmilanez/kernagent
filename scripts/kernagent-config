#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

YES=0
QUIET=0
NO_COLOR_FLAG=0
VERBOSE=0
CONFIG_FILE=""
SELECTED_MODEL=""
DISCOVERED_MODELS=()

CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
DEFAULT_CONFIG="${KERNAGENT_CONFIG:-${CONFIG_HOME}/kernagent/config.env}"

C_RED=""; C_GRN=""; C_YLW=""; C_BLU=""; C_RST=""

usage(){
  cat <<'USAGE'
kernagent-config [--yes] [--file PATH] [--no-color] [--quiet] [--verbose]

Creates or updates an OpenAI-compatible config file at ~/.config/kernagent/config.env by default.
USAGE
}

configure_colors(){
  if [[ -t 1 && "$NO_COLOR_FLAG" -eq 0 ]]; then
    C_RED=$'\033[31m'
    C_GRN=$'\033[32m'
    C_YLW=$'\033[33m'
    C_BLU=$'\033[34m'
    C_RST=$'\033[0m'
  fi
}

log(){ [[ "$QUIET" -eq 1 ]] && return 0; echo "${C_BLU}[*]${C_RST} $*"; }
ok(){ [[ "$QUIET" -eq 1 ]] && return 0; echo "${C_GRN}[âœ“]${C_RST} $*"; }
warn(){ echo "${C_YLW}[!]${C_RST} $*" >&2; }
die(){ echo "${C_RED}[x]${C_RST} $*" >&2; exit 1; }
run(){ if [[ "$VERBOSE" -eq 1 ]]; then echo "+ $*" >&2; fi; "$@"; }

convert_base_for_container(){
  local base="$1"
  local converted="$base"
  case "$base" in
    http://localhost*|https://localhost*)
      converted="${base/localhost/host.docker.internal}"
      ;;
    http://127.0.0.1*|https://127.0.0.1*)
      converted="${base/127.0.0.1/host.docker.internal}"
      ;;
    http://0.0.0.0*|https://0.0.0.0*)
      converted="${base/0.0.0.0/host.docker.internal}"
      ;;
  esac
  if [[ "$converted" != "$base" ]]; then
    # Send informational message to stderr to avoid polluting stdout
    { log "Local endpoint detected; using host.docker.internal in config so Docker containers can reach it." >&2; } || true
  fi
  printf '%s\n' "$converted"
}

parse_args(){
  CONFIG_FILE="$DEFAULT_CONFIG"
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --file)
        [[ $# -lt 2 ]] && { usage >&2; exit 2; }
        CONFIG_FILE="$2"
        shift 2
        ;;
      --file=*)
        CONFIG_FILE="${1#*=}"
        shift
        ;;
      --yes)
        YES=1
        shift
        ;;
      --quiet)
        QUIET=1
        shift
        ;;
      --no-color)
        NO_COLOR_FLAG=1
        shift
        ;;
      --verbose)
        VERBOSE=1
        shift
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        warn "Unknown option: $1"
        usage >&2
        exit 2
        ;;
    esac
  done
}

all_env_present(){
  [[ -n "${OPENAI_API_KEY:-}" && -n "${OPENAI_BASE_URL:-}" && -n "${OPENAI_MODEL:-}" ]]
}

write_config(){
  local base="$1" key="$2" model="$3"
  local dir
  dir="$(dirname "$CONFIG_FILE")"
  run mkdir -p "$dir"
  local previous_umask
  previous_umask="$(umask)"
  umask 077
  {
    printf 'OPENAI_API_KEY=%q\n' "$key"
    printf 'OPENAI_BASE_URL=%q\n' "$base"
    printf 'OPENAI_MODEL=%q\n' "$model"
    printf 'DEBUG=false\n'
  } > "$CONFIG_FILE"
  umask "$previous_umask"
  chmod 600 "$CONFIG_FILE" 2>/dev/null || true
  ok "Config saved to $CONFIG_FILE"
}

missing_env_msg(){
  local missing=()
  [[ -z "${OPENAI_BASE_URL:-}" ]] && missing+=(OPENAI_BASE_URL)
  [[ -z "${OPENAI_API_KEY:-}" ]] && missing+=(OPENAI_API_KEY)
  [[ -z "${OPENAI_MODEL:-}" ]] && missing+=(OPENAI_MODEL)
  printf '%s\n' "Missing required variables: ${missing[*]}"
}

prompt_input(){
  local prompt="$1" default="$2" value
  while true; do
    if [[ -n "$default" ]]; then
      read -r -p "$prompt [$default]: " value
      value="${value:-$default}"
    else
      read -r -p "$prompt: " value
    fi
    [[ -n "$value" ]] && { printf '%s\n' "$value"; return 0; }
    warn "Input cannot be empty"
  done
}

prompt_secret(){
  local prompt="$1" default="$2" value
  if [[ -n "$default" ]]; then
    read -r -s -p "$prompt [hidden]: " value
    echo ""
    printf '%s\n' "${value:-$default}"
  else
    while true; do
      read -r -s -p "$prompt: " value
      echo ""
      [[ -n "$value" ]] && { printf '%s\n' "$value"; return 0; }
      warn "Value cannot be empty"
    done
  fi
}

fetch_models(){
  local base="$1" key="$2" url tmp have_client=0 query_base="$1"
  if [[ "$query_base" == *"host.docker.internal"* ]] || [[ "$query_base" == *"host.containers.internal"* ]]; then
    query_base="${query_base//host.docker.internal/localhost}"
    query_base="${query_base//host.containers.internal/localhost}"
    log "Discovering models via ${query_base} (config will keep ${base})"
  fi
  DISCOVERED_MODELS=()
  url="${query_base%/}/models"
  tmp="$(mktemp)"
  if command -v curl >/dev/null 2>&1; then
    have_client=1
    if [[ -n "$key" && "$key" != "not-needed" ]]; then
      if ! curl -fsSL -H "Authorization: Bearer $key" "$url" -o "$tmp"; then
        rm -f "$tmp"
        return 1
      fi
    else
      if ! curl -fsSL "$url" -o "$tmp"; then
        rm -f "$tmp"
        return 1
      fi
    fi
  elif command -v wget >/dev/null 2>&1; then
    have_client=1
    local header=()
    if [[ -n "$key" && "$key" != "not-needed" ]]; then
      header=(--header="Authorization: Bearer $key")
    fi
    if ! wget -qO "$tmp" "${header[@]}" "$url"; then
      rm -f "$tmp"
      return 1
    fi
  fi
  if [[ "$have_client" -eq 0 ]]; then
    rm -f "$tmp"
    warn "Neither curl nor wget available; skipping auto-detection"
    return 1
  fi
  if command -v python3 >/dev/null 2>&1; then
    local models_output
    if ! models_output="$(python3 - "$tmp" <<'PY'
import json, sys
path = sys.argv[1]
with open(path, 'rb') as fh:
    try:
        data = json.load(fh)
    except Exception:
        sys.exit(1)
items = []
if isinstance(data, dict):
    data = data.get('data') or data.get('models') or []
for entry in data or []:
    if isinstance(entry, dict):
        ident = entry.get('id') or entry.get('name')
        if ident:
            items.append(ident)
if not items and isinstance(data, list):
    for entry in data:
        if isinstance(entry, dict):
            ident = entry.get('id') or entry.get('name')
            if ident:
                items.append(ident)
for item in items:
    print(item)
PY
)"; then
      rm -f "$tmp"
      return 1
    fi
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      DISCOVERED_MODELS+=("$line")
    done <<< "$models_output"
  else
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      DISCOVERED_MODELS+=("$line")
    done < <(grep -o '"id"\s*:\s*"[^"]\+"' "$tmp" 2>/dev/null | sed -E 's/"id"\s*:\s*"([^"]+)"/\1/' | sort -u || true)
  fi
  rm -f "$tmp"
  return 0
}

choose_model(){
  local base="$1" key="$2"
  SELECTED_MODEL=""
  if fetch_models "$base" "$key" && [[ ${#DISCOVERED_MODELS[@]} -gt 0 ]]; then
    log "Detected ${#DISCOVERED_MODELS[@]} models"
    local idx=1
    for model in "${DISCOVERED_MODELS[@]}"; do
      printf '%2d) %s\n' "$idx" "$model"
      ((idx++))
      if (( idx > 20 )); then
        printf '... (%d total)\n' "${#DISCOVERED_MODELS[@]}"
        break
      fi
    done
    local choice
    read -r -p "Select model [1]: " choice
    choice="${choice:-1}"
    if [[ "$choice" =~ ^[0-9]+$ && "$choice" -ge 1 && "$choice" -le ${#DISCOVERED_MODELS[@]} ]]; then
      SELECTED_MODEL="${DISCOVERED_MODELS[$((choice-1))]}"
      return 0
    fi
    warn "Invalid selection"
  fi
  SELECTED_MODEL="$(prompt_input "Model ID" "${OPENAI_MODEL:-}")"
}

interactive_flow(){
  local selection base key model
  cat <<'MENU'
Choose a provider:
  1) OpenAI (https://api.openai.com/v1)
  2) Google (OpenAI-compatible)
  3) Anthropic (OpenAI-compatible)
  4) Local (LM Studio / Ollama)
  5) Custom
MENU
  while true; do
    read -r -p "Selection [1]: " selection
    selection="${selection:-1}"
    case "$selection" in
      1)
        base=${OPENAI_BASE_URL:-https://api.openai.com/v1}
        key=$(prompt_secret "OpenAI API key" "${OPENAI_API_KEY:-}" )
        break
        ;;
      2)
        base=${OPENAI_BASE_URL:-https://generativelanguage.googleapis.com/v1beta/openai/}
        key=$(prompt_secret "Google API key" "${OPENAI_API_KEY:-}" )
        break
        ;;
      3)
        base=${OPENAI_BASE_URL:-https://api.anthropic.com/v1}
        key=$(prompt_secret "Anthropic API key" "${OPENAI_API_KEY:-}" )
        break
        ;;
      4)
        base=${OPENAI_BASE_URL:-http://localhost:1234/v1}
        key=${OPENAI_API_KEY:-not-needed}
        log "Using default key placeholder 'not-needed'"
        break
        ;;
      5)
        base=$(prompt_input "Base URL" "${OPENAI_BASE_URL:-http://localhost:1234/v1}")
        key=$(prompt_secret "API key (enter 'not-needed' if none)" "${OPENAI_API_KEY:-}" )
        break
        ;;
      *)
        warn "Invalid selection"
        ;;
    esac
  done
  choose_model "$base" "$key"
  local config_base
  config_base="$(convert_base_for_container "$base")"
  write_config "$config_base" "$key" "$SELECTED_MODEL"
}

main(){
  parse_args "$@"
  configure_colors
  if all_env_present; then
    log "Using OPENAI_* environment variables"
    local config_base
    config_base="$(convert_base_for_container "$OPENAI_BASE_URL")"
    write_config "$config_base" "$OPENAI_API_KEY" "$OPENAI_MODEL"
    exit 0
  fi
  if [[ "$YES" -eq 1 ]]; then
    missing_env_msg >&2
    die "Set the missing variables above or run interactively"
  fi
  if [[ ! -t 0 || ! -t 1 ]]; then
    die "Interactive mode requires a TTY. Provide OPENAI_* env vars and re-run with --yes"
  fi
  interactive_flow
}

main "$@"
